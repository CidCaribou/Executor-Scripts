const swalScript = document.createElement('script');
swalScript.src = 'https://cdn.jsdelivr.net/npm/sweetalert2@11';
document.head.appendChild(swalScript);

Swal.close(); 
Swal.fire({}); 

swalScript.onload = function() {
    main(); 
};

function main() {
    let url = "https://www.minecraft.net/en-us/15th-anniversary";

    function showLoading() {
        Swal.fire({
            title: "Please Wait",
            text: "Processing...",
            timer: null,
            allowOutsideClick: false,
            didOpen: () => {
                Swal.showLoading();
            }
        });
    }

    function processRequest() {
        showLoading(); 

        try {
            const mcTokenData = localStorage.getItem('MCToken');
            if (!mcTokenData) {
                Swal.fire("Error", "No Minecraft Token found in localStorage!", "error");
                return;
            }
            const mcToken = JSON.parse(mcTokenData).mcToken;

            fetch("https://net.web.minecraft-services.net/api/v1.0/grant/offer?offer=7118a7d5-240e-4f6d-8959-5269ba041938", {
                headers: {
                    accept: "*/*",
                    authorization: mcToken,
                    "content-type": "application/json",
                },
                method: "PUT",
                credentials: "include"
            })
            .then(response => {
                console.log("Status Code:", response.status);
                if (response.status === 204) {
                    Swal.fire("Success", "Please log out of minecraft and then log back in to claim cape.", "success");
                } else {
                    Swal.fire("Error", "Patched or something went wrong.", "error");
                }
            })
            .catch(() => {
                Swal.fire("Error", "Network request failed.", "error");
            });

        } catch (e) {
            Swal.fire("Error", "An unexpected error occurred.", "error");
        }
    }

    function checkLoggedIn() {
        Swal.fire({
            title: "Are you logged into Minecraft?",
            text: "Make sure you're logged into your Minecraft account before proceeding.",
            icon: "question",
            showCancelButton: true,
            timer: null,
            confirmButtonText: "Yes, I'm logged in",
            cancelButtonText: "No, take me to login"
        }).then((result) => {
            if (result.isConfirmed) {
                processRequest(); 
            } else {
                window.open("https://www.minecraft.net/", "_blank");
                Swal.fire("Please Login", "Redirecting you to Minecraft.net", "info");
            }
        });
    }

    if (window.location.href !== url) {
        Swal.fire({
            title: "Incorrect Website",
            text: "Would you like to go to the correct website? If so please reopen the script on the correct website.",
            icon: "warning",
            showCancelButton: true,
            timer: null,
            confirmButtonText: "Yes",
            cancelButtonText: "No"
        }).then((result) => {
            if (result.isConfirmed) {
                window.open(url, "_blank");
            } else {
                Swal.fire("Operation Cancelled", "", "info");
            }
        });
    } else {
        Swal.fire({
            title: "Are you sure?",
            text: "Do you want to proceed?",
            icon: "question",
            showCancelButton: true,
            timer: null,
            confirmButtonText: "Yes",
            cancelButtonText: "No"
        }).then((result) => {
            if (result.isConfirmed) {
                checkLoggedIn();
            } else {
                Swal.fire("Operation Cancelled", "", "info");
            }
        });
    }
}
